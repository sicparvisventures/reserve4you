# üë• GEBRUIKERSBEHEERSYSTEEM - COMPLETE GUIDE

## üéØ **OVERZICHT:**

Een volledig gebruikersbeheersysteem voor Reserve4You met:
- 4 gebruikersrollen met specifieke rechten
- PIN-gebaseerde login (4 cijfers)
- iPhone-style numeric keypad
- Per-locatie toegangsbeheer
- Granulaire permissions per module
- Floating button voor snelle staff toegang

---

## üìä **GEBRUIKERSROLLEN:**

### **1. Administrator**
- ‚úÖ Volledige toegang tot alle functies
- ‚úÖ Kan gebruikers aanmaken, bewerken en verwijderen
- ‚úÖ Kan rechten van andere gebruikers wijzigen
- ‚úÖ Toegang tot instellingen en facturatie
- ‚úÖ Alle locaties beheer

**Gebruik voor:** Eigenaren, general managers

### **2. Standaard Gebruiker**
- ‚úÖ Beperkte toegang op basis van toegekende rechten
- ‚úÖ Toegang tot specifieke modules (reserveringen, klanten, etc.)
- ‚úÖ Kan per locatie toegang hebben
- ‚ùå Geen gebruikersbeheer

**Gebruik voor:** Shift managers, receptiemedewerkers

### **3. Viewer**
- ‚úÖ Alleen-lezen toegang
- ‚úÖ Kan data bekijken maar niet wijzigen
- ‚úÖ Toegang tot dashboard en analytics
- ‚ùå Geen bewerkrechten

**Gebruik voor:** Externe partijen, shift leaders zonder bewerkrechten

### **4. Groepsbeheerder (Multi-locatie)**
- ‚úÖ Beheer over meerdere vestigingen
- ‚úÖ Kan data delen tussen locaties
- ‚úÖ Centraliseer inzichten en rapportage
- ‚úÖ Verschillende rechten per locatie mogelijk

**Gebruik voor:** Franchise managers, district managers, group owners

---

## üöÄ **SETUP INSTRUCTIES:**

### **Stap 1: Run SQL Script**

```bash
# Open Supabase SQL Editor
# Run: USER_MANAGEMENT_SYSTEM_SETUP.sql
```

Dit script cre√´ert:
- ‚úÖ `venue_users` table
- ‚úÖ `venue_user_sessions` table
- ‚úÖ `user_role` enum type
- ‚úÖ Helper functions voor authentication
- ‚úÖ RLS policies

### **Stap 2: Restart Development Server**

```bash
# Stop current server (Ctrl+C)
# Restart:
npm run dev
```

### **Stap 3: Toegang tot Features**

**Gebruikersbeheer:**
```
http://localhost:3007/profile
‚Üí Tab: "Gebruikers"
```

**Staff Login:**
```
http://localhost:3007/staff-login
OF
Click floating button (bottom-left op homepage)
```

---

## üìù **GEBRUIKER AANMAKEN:**

### **Via Profile ‚Üí Gebruikers:**

1. **Ga naar Gebruikersbeheer:**
   - Login als admin/owner
   - Go to `/profile`
   - Click tab "Gebruikers"

2. **Click "Nieuwe Gebruiker"**

3. **Vul formulier in:**
   ```
   Voornaam: John
   Achternaam: Doe
   E-mail: john@restaurant.com (optioneel)
   Telefoon: +32 123 45 67 89 (optioneel)
   PIN Code: 1234 (4 cijfers, uniek per bedrijf)
   Rol: Kies uit 4 opties
   ```

4. **Vestigingen Toegang:**
   - Toggle "Alle vestigingen" AAN voor volledige toegang
   - OF selecteer specifieke locaties

5. **Rechten & Permissies:**
   Vink aan welke modules toegankelijk zijn:
   - Dashboard bekijken
   - Reserveringen beheren
   - Klanten beheren
   - Tafels beheren
   - Menu beheren
   - Promoties beheren
   - Analytics bekijken
   - Instellingen beheren
   - Gebruikers beheren
   - Facturatie beheren

6. **Click "Aanmaken"**

7. **Geef PIN code door aan gebruiker**
   - PIN is nodig om in te loggen
   - Houd PIN priv√© en veilig

---

## üîê **STAFF LOGIN PROCES:**

### **Optie 1: Via Floating Button**

```
1. Ga naar homepage: http://localhost:3007
2. Zie floating button linksonder (lock icon)
3. Click op button
4. Komt op PIN login scherm
5. Voer 4-cijferige PIN in
6. Auto-submit bij 4e cijfer
7. Redirect naar staff dashboard
```

### **Optie 2: Direct Link**

```
1. Ga naar: http://localhost:3007/staff-login
2. Voer PIN in op numpad
3. Click "Clear" om te wissen
4. Click backspace om laatste cijfer te verwijderen
5. Login bij correcte PIN
```

### **Login Flow:**

```
Homepage
   ‚Üì
[Floating Button Click]
   ‚Üì
Staff Login Page
   ‚Üì
[Enter PIN: 1234]
   ‚Üì
Verify in Database
   ‚Üì
Create Session
   ‚Üì
Store in localStorage
   ‚Üì
Redirect to Staff Dashboard
```

---

## üé® **UI/UX FEATURES:**

### **PIN Login Scherm:**

**Design:**
- Mobile-first responsive design
- iPhone-style numeric keypad
- Gradient background (gray-50 to gray-100)
- White card met rounded corners (3xl)
- Shadow voor depth
- Professional typography

**Components:**
- Lock icon in cirkel (primary color)
- 4 PIN input dots (filled/empty states)
- 3√ó4 number grid (1-9, Clear, 0, Backspace)
- Error messages met AlertCircle icon
- Loading spinner tijdens verificatie
- "Terug naar home" button

**Interaction:**
- Touch/click op nummer ‚Üí voeg toe aan PIN
- Auto-submit bij 4 cijfers
- Clear button ‚Üí reset PIN
- Backspace ‚Üí verwijder laatste cijfer
- Haptic-achtige transitions
- Hover states op alle buttons

### **Gebruikersbeheer UI:**

**List View:**
- Card per gebruiker
- Name, role badge, status badge
- Contact info (email, phone)
- PIN (verborgen als ‚Ä¢‚Ä¢‚Ä¢‚Ä¢)
- Laatste login tijd
- Permission badges
- Edit/Delete buttons

**Form:**
- Two-column responsive grid
- PIN input met Key icon
- Large centered PIN display (2xl font)
- Role selector met descriptions
- Location checkboxes in scrollable grid
- Permission checkboxes in grid layout
- Save/Cancel buttons

---

## üîß **DATABASE SCHEMA:**

### **venue_users Table:**

```sql
CREATE TABLE venue_users (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  user_id UUID (link to auth.users),
  
  -- Info
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  email TEXT,
  phone TEXT,
  
  -- Auth
  pin_code TEXT NOT NULL UNIQUE, -- 4 digits
  role user_role NOT NULL,
  
  -- Access
  location_ids UUID[],
  all_locations BOOLEAN DEFAULT false,
  
  -- Permissions (10 different flags)
  can_view_dashboard BOOLEAN,
  can_manage_bookings BOOLEAN,
  can_manage_customers BOOLEAN,
  can_manage_tables BOOLEAN,
  can_manage_menu BOOLEAN,
  can_manage_promotions BOOLEAN,
  can_view_analytics BOOLEAN,
  can_manage_settings BOOLEAN,
  can_manage_users BOOLEAN,
  can_manage_billing BOOLEAN,
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  last_login_at TIMESTAMP,
  
  -- Metadata
  created_by UUID,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### **venue_user_sessions Table:**

```sql
CREATE TABLE venue_user_sessions (
  id UUID PRIMARY KEY,
  venue_user_id UUID NOT NULL,
  tenant_id UUID NOT NULL,
  
  login_at TIMESTAMP DEFAULT NOW(),
  logout_at TIMESTAMP,
  ip_address TEXT,
  user_agent TEXT,
  
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## üîç **HELPER FUNCTIONS:**

### **1. verify_pin_and_login()**

Verificeert PIN en cre√´ert sessie:

```sql
SELECT * FROM verify_pin_and_login(
  p_tenant_id := 'uuid-here',
  p_pin_code := '1234',
  p_ip_address := '127.0.0.1',
  p_user_agent := 'Mozilla/5.0...'
);

-- Returns:
-- success: boolean
-- user_data: jsonb (user info + permissions)
-- session_id: uuid
```

### **2. get_user_permissions()**

Haalt gebruikersrechten op:

```sql
SELECT * FROM get_user_permissions(
  p_tenant_id := 'uuid-here',
  p_pin_code := '1234'
);

-- Returns:
-- user_id: uuid
-- full_name: text
-- role: user_role
-- permissions: jsonb
```

---

## üß™ **TESTING GUIDE:**

### **Test 1: Gebruiker Aanmaken**

```
1. Go to: http://localhost:3007/profile
2. Tab: Gebruikers
3. Click: "Nieuwe Gebruiker"
4. Fill:
   - Voornaam: Test
   - Achternaam: User
   - PIN: 1111
   - Rol: Standard
   - Rechten: Dashboard + Reserveringen
5. Click: "Aanmaken"
6. ‚úÖ Gebruiker verschijnt in lijst
```

### **Test 2: PIN Login**

```
1. Go to: http://localhost:3007
2. Click: Floating button (linksonder)
3. Kom op: Staff Login pagina
4. Enter PIN: 1111
5. ‚úÖ Auto-submit na 4e cijfer
6. ‚úÖ Redirect naar dashboard
7. ‚úÖ Session opgeslagen in localStorage
```

### **Test 3: Foute PIN**

```
1. Staff Login pagina
2. Enter PIN: 9999 (onbestaande)
3. ‚úÖ Error: "Ongeldige PIN code"
4. ‚úÖ PIN reset naar leeg
5. ‚úÖ Kan opnieuw proberen
```

### **Test 4: Gebruiker Bewerken**

```
1. Gebruikerslijst
2. Click: Edit button op gebruiker
3. Wijzig: Rol ‚Üí Administrator
4. Voeg toe: Instellingen beheren
5. Click: "Bijwerken"
6. ‚úÖ Wijzigingen opgeslagen
7. ‚úÖ Updated_at timestamp gewijzigd
```

### **Test 5: Gebruiker Verwijderen**

```
1. Gebruikerslijst
2. Click: Delete button (rood)
3. Confirm: "Weet je het zeker?"
4. Click: OK
5. ‚úÖ Gebruiker verwijderd
6. ‚úÖ Sessions ook verwijderd (CASCADE)
```

---

## üîê **SECURITY FEATURES:**

### **Row Level Security (RLS):**

```sql
-- Only tenant admins can manage users
CREATE POLICY "Tenant admins can manage venue users"
ON venue_users FOR ALL
TO authenticated
USING (
  tenant_id IN (
    SELECT m.tenant_id FROM memberships m
    WHERE m.user_id = auth.uid()
    AND m.role IN ('owner', 'manager')
  )
);
```

### **PIN Constraints:**

- Exactly 4 digits required
- UNIQUE per tenant (no duplicates)
- Stored as TEXT (not hashed for easy reset)
- Pattern validation: `^\d{4}$`

### **Session Management:**

- Session ID stored in localStorage
- IP address + user agent tracked
- Last login timestamp updated
- Logout functionality available

---

## üì± **MOBILE-FIRST DESIGN:**

### **Responsive Breakpoints:**

```css
/* Mobile (default) */
- Single column forms
- Full-width buttons
- Touch-optimized button size (min 44px)

/* Tablet (md:) */
- Two-column grid for forms
- Side-by-side permission checkboxes

/* Desktop (lg:) */
- Max-width containers
- Optimal spacing
- Hover states enhanced
```

### **Touch Optimizations:**

- Large tap targets (48px√ó48px minimum)
- No hover-only functionality
- Swipe-friendly list items
- Pinch-zoom disabled on numpad
- Haptic-like visual feedback

---

## üé® **STYLING CONSISTENCY:**

### **Color Palette:**

```css
Primary: #263e0f (green)
Background: white, gray-50, gray-100
Text: gray-900, gray-600
Error: red-600
Success: green-600
Border: gray-200, gray-300
```

### **Typography:**

```css
Headings: font-bold, text-xl to text-2xl
Body: font-normal, text-sm to text-base
Labels: font-medium, text-sm
Buttons: font-semibold, text-sm
```

### **Shadows:**

```css
Card: shadow-lg
Floating button: shadow-xl on hover
Modal: shadow-2xl
Subtle: shadow-sm
```

---

## üö® **TROUBLESHOOTING:**

### **Problem: PIN niet geaccepteerd**

**Diagnose:**
```sql
-- Check if PIN exists
SELECT * FROM venue_users 
WHERE pin_code = '1234' 
AND tenant_id = 'your-tenant-id';

-- Check if user is active
SELECT is_active FROM venue_users WHERE pin_code = '1234';
```

**Fix:**
- Verify PIN is exactly 4 digits
- Check user is_active = true
- Check tenant_id is correct
- Try different PIN

### **Problem: Floating button niet zichtbaar**

**Diagnose:**
- Check browser console for errors
- Verify StaffLoginFloatingButton is imported
- Check z-index conflicts

**Fix:**
```typescript
// Increase z-index if needed
className="... z-[9999]"
```

### **Problem: Permission changes niet zichtbaar**

**Diagnose:**
```sql
-- Check user permissions in DB
SELECT 
  first_name, 
  last_name,
  can_manage_bookings,
  can_view_dashboard,
  updated_at
FROM venue_users
WHERE id = 'user-id';
```

**Fix:**
- Hard refresh browser (Ctrl+Shift+R)
- Clear localStorage
- Re-login

### **Problem: Duplicate PIN error**

**Error:** `23505: unique constraint violation`

**Fix:**
```sql
-- Find duplicate
SELECT pin_code, COUNT(*) 
FROM venue_users 
WHERE tenant_id = 'tenant-id'
GROUP BY pin_code 
HAVING COUNT(*) > 1;

-- Change PIN
UPDATE venue_users 
SET pin_code = '5678' 
WHERE id = 'user-id';
```

---

## üìä **ANALYTICS & MONITORING:**

### **Track User Activity:**

```sql
-- Login history
SELECT 
  vu.first_name || ' ' || vu.last_name as user_name,
  vus.login_at,
  vus.ip_address,
  EXTRACT(EPOCH FROM (vus.logout_at - vus.login_at))/60 as session_duration_minutes
FROM venue_user_sessions vus
JOIN venue_users vu ON vu.id = vus.venue_user_id
WHERE vu.tenant_id = 'tenant-id'
ORDER BY vus.login_at DESC
LIMIT 100;

-- Most active users
SELECT 
  vu.first_name || ' ' || vu.last_name as user_name,
  COUNT(*) as login_count,
  MAX(vus.login_at) as last_login
FROM venue_users vu
LEFT JOIN venue_user_sessions vus ON vus.venue_user_id = vu.id
WHERE vu.tenant_id = 'tenant-id'
GROUP BY vu.id, vu.first_name, vu.last_name
ORDER BY login_count DESC;
```

---

## üéØ **BEST PRACTICES:**

### **DO:**
- ‚úÖ Gebruik unieke PIN codes per gebruiker
- ‚úÖ Wijzig PIN regelmatig voor hoge rechten accounts
- ‚úÖ Geef minimale rechten (principle of least privilege)
- ‚úÖ Review gebruikerstoegang maandelijks
- ‚úÖ Deactiveer users in plaats van verwijderen (audit trail)
- ‚úÖ Track login activiteit
- ‚úÖ Train personeel over PIN beveiliging

### **DON'T:**
- ‚ùå Deel PIN codes
- ‚ùå Gebruik sequenti√´le PINs (1234, 2345, etc.)
- ‚ùå Gebruik geboortedatums als PIN
- ‚ùå Laat PINs onbeheerd zichtbaar
- ‚ùå Geef iedereen administrator rechten
- ‚ùå Vergeet inactieve users te deactiveren

---

## üìù **FILES OVERZICHT:**

```
SQL Scripts:
‚úÖ USER_MANAGEMENT_SYSTEM_SETUP.sql - Database schema & functions

Frontend Components:
‚úÖ components/manager/UsersManager.tsx - User management UI
‚úÖ app/profile/ProfileClient.tsx - Added "Gebruikers" tab
‚úÖ app/staff-login/page.tsx - Staff login server component
‚úÖ app/staff-login/PINLoginClient.tsx - PIN login client
‚úÖ components/staff/StaffLoginFloatingButton.tsx - Floating button
‚úÖ app/page.tsx - Homepage with floating button

Documentation:
‚úÖ USER_MANAGEMENT_COMPLETE_GUIDE.md - This file
```

---

## üéâ **KLAAR VOOR GEBRUIK!**

Het complete gebruikersbeheersysteem is ge√Ømplementeerd en klaar voor gebruik!

**Start testing:**
1. Run SQL script in Supabase
2. Restart dev server
3. Go to /profile ‚Üí Gebruikers
4. Maak eerste gebruiker aan
5. Test PIN login via floating button
6. Verify permissions werken

**Succes met je nieuwe gebruikersbeheersysteem! üöÄ**

